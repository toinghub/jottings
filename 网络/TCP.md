# [TCP](https://juejin.cn/post/6844903748578312206?searchId=20231018154742D5024DAD61C3E8A9342E)

* `Transmission Control Protocol`，即 传输控制协议

* 基于两端的ip和端口和协议来建立的，在切换网络场景时，会改变本身的ip，这就导致tcp连接必须重新创建
* 三次握手期间，任何1次未收到对面的回复，则都会重发

## 特点

#### 面向链接

* 使用TCP传输数据前，必须先建立TCP连接欸；传输完成后再释放连接

#### 全双工同行

* 建立TCP连接后，通信双方都能发送数据

#### 可靠

* 数据不丢失、无差错、不重复
* 数据按序到达

#### 面向字节流

* 流：流入/流出进程的字符序列
* TCP一次传输的报文长度有限制，若太大则需分块、分次传输
* 分块、分次传输的数据，由于TCP连接的可靠性，接收方可按顺序接收数据块并重新组成分开之前的数据流
* 故TCP看起来就像直接互相传输字节流，所以叫 面向字节流

## 优缺点

| **优点** |             **数据传输可靠**             |
| :------: | :--------------------------------------: |
| **缺点** | **效率慢（因需建立连接、发送确认包等）** |

## 名词解释

| **SYN** |    **建立连接**    |
| :-----: | :----------------: |
| **HIN** |   **终止控制位**   |
| **ACK** |      **响应**      |
| **seq** |      **序号**      |
| **ack** |   **确认号字段**   |
| **MSL** | **最长报文段寿命** |

## 三次握手

![](../images\TCP三次握手.png)

### 第一次握手

> 确认客户端发送正常
>
> 客户端向服务器发送1个连接请求的报文段

#### 报文段信息

* 同步标志位：SYN = 1
* 随机选择一个起始序列：seq = x
* 不携带数据（SYN位被设置为1不能携带数据,消耗一个序列号）

#### 状态

* 客户端进入 同步已发送 状态（SYN_SEND）
* 等待服务器确认

### 第二次握手

> 确认服务端接受发送正常
>
> 服务器收到请求连接报文段后，同意连接则向客户端发回连接确认的报文段

#### 报文段信息

* 同步标志位：SYN = 1
* 确认标志位：ACK = 1
* 随机选择一个起始序号：seq = y
* 确认号字段：ack = x + 1
* 不携带数据（SYN位被设置为1不能携带数据,消耗一个序列号）

#### 状态

* 服务器进入 同步已接收 状态（SYN_RCVD)

### 第三次握手

> 确认客户端接受正常
>
> 客户端收到确认报文段后，向服务器再次发出连接确认报文段

#### 报文段信息

* 确认标志位： ACK = 1
* 序号：seq = x+1
* 确认号字段：ack = y+1
* 可携带数据（SYN != 1,不携带不消耗序列号)

#### 状态

* 客户端、服务器都进入已创建状态（ESTABLISHED）
* 可开始发送数据

## 四次挥手

![](..\images\TCP四次挥手.png)

### 第一次挥手

> 客户端向服务器发送连接释放的报文段
>
> 客服端停止再主动发送数据

#### 报文段信息

* 终止控制位: FIN = 1
* 报文段序号: seq = u (前面传送数据最后1个字节的序号+1)
* 可携带数据(FIN = 1 ,不携带也消耗一个序号)

#### 状态

* 客户端进入 终止等待1 状态( FIN-WAIT-1 )
* 等待服务器的确认

### 第二次挥手

> 服务器收到连接释放报文段,则向客户端发回连接释放确认的报文段

#### 报文段信息

* 确认标记位: ACK = 1
* 报文段序号: seq = v ( 前面传送数据最后1个字节的序号+1)
* 确认号字段: ack = u + 1

#### 状态

* 服务器进入 关闭等待 状态(CLOSE-WAIT)
* 客户端收到服务器的确认后,进入 终止等待2 状态(FIN-WAIT-2),等待服务器发出释放连接请求
* 客户端 !=> 服务器   服务器=>客户端

### 第三次挥手

> 服务器已无要向客户端发送数据,则发出释放连接的报文段

#### 报文段信息

* 终止控制位: FIN = 1
* 确认标志位: ACK = 1
* 报文段序号: seq = w
* 确认号字段: ack = u + 1(重复上次已发送的)
* 可携带数据(FIN = 1 ,不携带也消耗一个序号)

#### 状态

* 服务器进入 最后确认 状态(LAST-ACK)

### 第四次挥手

> 客户端收到连接释放报文段后,则向服务器发回连接释放确认的报文段

#### 报文段信息

* 确认标志位: ACK = 1
* 报文段序号: seq = u + 1
* 确认号字段: ack = w + 1
* 可携带数据(FIN = 1 ,不携带也消耗一个序号)

#### 状态

* 客户端进入 时间等待 状态(TIME-WAIT)
* 服务器进入 关闭状态 (CLOSED)
* 经过时间等待计时器设置的时间2MSL后,,客户端才进入 关闭 状态(CLOSED)

#### 为什么客户端关闭要等待2msl时间

1. 保证客户端发送的最后1个连接释放确认报文能到达服务器
2. 防止 早已失效的连接请求报文 出现在本连接中



